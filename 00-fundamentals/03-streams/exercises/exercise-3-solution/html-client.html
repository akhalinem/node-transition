<!DOCTYPE html>
<html>
<head>
    <title>File Upload with Streams</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        #dropzone {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
        }
        #dropzone.dragover {
            border-color: #4CAF50;
            background-color: #f0f8ff;
        }
        #progress-container {
            display: none;
            margin: 20px 0;
        }
        #progress-bar {
            width: 100%;
            height: 30px;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }
        #progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        #status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üì§ File Upload with Streams</h1>
    <p>Upload files using Node.js streams with real-time progress tracking</p>
    
    <div id="dropzone">
        <p>üìÅ Click to select a file or drag & drop here</p>
        <input type="file" id="fileInput" style="display: none;">
    </div>
    
    <div id="progress-container">
        <div id="progress-bar">
            <div id="progress-fill">0%</div>
        </div>
        <div id="status"></div>
    </div>

    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const status = document.getElementById('status');

        dropzone.addEventListener('click', () => fileInput.click());
        
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                uploadFile(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                uploadFile(e.target.files[0]);
            }
        });

        function uploadFile(file) {
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';
            status.className = 'info';
            status.textContent = `Uploading ${file.name}...`;

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);
            xhr.setRequestHeader('X-Filename', file.name.replace(/[^a-zA-Z0-9._-]/g, '_'));
            
            // Listen to SSE progress events
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 3) { // LOADING
                    const lines = xhr.responseText.split('\\n');
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                
                                if (data.type === 'progress') {
                                    progressFill.style.width = data.percent + '%';
                                    progressFill.textContent = data.percent + '%';
                                    status.className = 'info';
                                    status.textContent = `${data.speed} | ETA: ${data.eta}`;
                                } 
                                else if (data.type === 'complete') {
                                    progressFill.style.width = '100%';
                                    progressFill.textContent = '100%';
                                    status.className = 'success';
                                    status.innerHTML = `
                                        ‚úÖ Upload complete!<br>
                                        File: ${data.filename}<br>
                                        Size: ${(data.size / 1024 / 1024).toFixed(2)} MB<br>
                                        SHA256: ${data.checksum}
                                    `;
                                }
                                else if (data.type === 'error') {
                                    status.className = 'error';
                                    status.textContent = '‚ùå Error: ' + data.message;
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    });
                }
            };
            
            xhr.onerror = function() {
                status.className = 'error';
                status.textContent = '‚ùå Upload failed: Network error';
            };

            xhr.send(file);
        }
    </script>
</body>
</html>